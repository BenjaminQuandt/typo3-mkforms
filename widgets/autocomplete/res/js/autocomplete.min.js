Formidable.Classes.Autocomplete=Formidable.Classes.RdtBaseClass.extend({oText:null,oList:null,oLoader:null,iLoaderCount:0,onListSelect:null,itemSelected:null,constructor:function(a){this.base(a)},initialize:function(){var a=this;if(!a.domNode())return;a.config.counter=0;a.config.isDbEntry=false;var b={};if(a.config.item.width)b.width=a.config.item.width+"px";if(a.config.item.height)b.height=a.config.item.height+"px";if(a.config.item.style)for(var d=a.config.item.style.split(";"),c=0;c<d.length;++c)if(!d[c].strip().empty()){var f=d[c].strip().split(":");b[f[0].strip().camelize()]=f[1].strip()}a.config.item.style=b;var e=MKWrapper.id(a.domNode());a.oText=MKWrapper.$(e);a.oList=MKWrapper.$(e+Formidable.SEP+"list");a.oLoader=MKWrapper.$(e+Formidable.SEP+"loader");a.oText.parentNode.insertBefore(a.oLoader,a.oList);a.initStartPosition();a.addScript(a)},initStartPosition:function(){var g="outermargin",c=false,b=true,f="absolute",e="relative",a=this;if(MKWrapper.isIE(7)){var d=MKWrapper.parent(a.oList);MKWrapper.setStyle(d,{height:MKWrapper.getDimensions(d).height});MKWrapper.each(MKWrapper.findChilds(d),function(a){MKWrapper.setStyle(a,{position:e})})}MKWrapper.setStyle(MKWrapper.parent(a.oList),{position:e});MKWrapper.setStyle(a.oList,{position:f});MKWrapper.setStyle(a.oLoader,{display:"block",height:"16px",width:"16px",background:"transparent url("+Formidable.path+"widgets/autocomplete/res/img/loader.gif) no-repeat scroll 0 0"});var h=MKWrapper.showParents(a.oList);MKWrapper.clonePosition(a.oList,a.oText,{setLeft:b,setTop:b,setWidth:c,setHeight:c,offsetLeft:0,offsetTop:MKWrapper.getDimensions(a.oText,g).height});MKWrapper.clonePosition(a.oLoader,a.oText,{setLeft:b,setTop:b,setWidth:c,setHeight:c,offsetLeft:MKWrapper.getDimensions(a.oText,g).width,offsetTop:1});MKWrapper.setStyle(a.oLoader,{position:f,display:"none"});MKWrapper.hideElements(h)},execEvents:function(){var a=this;a.oText.oObserver=MKWrapper.delayedObserver(a.oText,a.config.timeObserver,a.execAjaxRequest.bind(a));if(a.config.selectionRequired){MKWrapper.attachEvent(a.oText,"blur",a.checkSelection,a);MKWrapper.attachEvent(a.oText,"keydown",a.textChange,a)}else a.config.hideItemListOnLeave&&MKWrapper.attachEvent(document.getElementsByTagName("body")[0],"click",a.hideItemListOnLeave,a)},loaderShow:function(){MKWrapper.setStyle(this.oLoader,{display:"block"});this.iLoaderCount++},loaderHide:function(){this.iLoaderCount--;this.iLoaderCount===0&&MKWrapper.setStyle(this.oLoader,{display:"none"})},addScript:function(b){var a=this.config.jsExtend;if(a!==false)window.setTimeout(function(){a=a.split(":");MKWrapper.loadScript(a[0],function(){Formidable.Classes.Autocomplete[a[1]](b,a[2])});b.execEvents()},500);else b.execEvents()},execAjaxRequest:function(){if(this.itemSelected===true){this.itemSelected=null;return}var a=this,b=MKWrapper.$F(a.oText);if(b.length<2){a.hideItemList(a);return}a.config.counter++;a.loaderShow();MKWrapper.ajaxCall(a.config.searchUrl,{method:"post",asynchronous:false,parameters:{searchType:a.config.searchType,searchText:b,searchCounter:a.config.counter},onSuccess:function(d){var b=d;if(!MKWrapper.isJSON(b))return;var c=MKWrapper.evalJSON(b,true);c.tasks.counter==a.config.counter&&a.executeAjaxTasks(c.tasks);a.loaderHide()}})},executeAjaxTasks:function(b){var a=this;if(b.results>0)a.generateItemList(a,Formidable.objValues(b.html));else a.hideItemList(a)},textChange:function(b){var d="visible",a=this;if(b.keyCode==9)return;if(b.keyCode==40)a.oList.style.visibility===d&&a.itemSelect(a,MKWrapper.next(a.itemSelected));if(b.keyCode==38)a.oList.style.visibility===d&&a.itemSelect(a,MKWrapper.previous(a.itemSelected));if(b.keyCode==13){if(!a.config.isDbEntry&&a.itemSelected!==null){a.listSelect(a,a.itemSelected);a.enableButtons();a.itemSelected=true;return false}return true}if(b.keyCode==27){var c=a;if(!a.config.isDbEntry){if(typeof c.onlistselect!="undefined"&&c.onlistselect!==null)c.onlistselect("");setTimeout(function(){c.oText.value=""},50)}a.oList.style.visibility===d&&a.hideItemList(a);return}a.setDbEntryState(false)},checkSelection:function(){var a=this;if(a.oList.style.visibility==="visible")if(!a.oText.value.length)a.hideItemList(a);else window.setTimeout(function(){a.oText.focus()},10)},itemSelect:function(a,b){if(typeof b=="undefined")return false;MKWrapper.removeClass(a.itemSelected,a.config.selectedItemClass);MKWrapper.addClass(b,a.config.selectedItemClass);a.itemSelected=b},listSelect:function(a,c){var b=MKWrapper.stripTags(c.innerHTML);b=b.replace(/\s+/g," ").replace(/^\s+|\s+$/,"");a.setDbEntryState(true);a.oText.value=b;a.hideItemList(a);if(typeof a.onlistselect!="undefined"&&a.onlistselect!==null)a.onlistselect(b)},generateItemList:function(a,e){var g="mouseover",i=e[1]?e[1]:"<!-- last -->";a.oList.innerHTML=e[0]+i;MKWrapper.each(Formidable.objValues(e[2]),function(c,d){var b=MKWrapper.$tag("div",{});b.className=a.config.item["class"];MKWrapper.setStyle(b,a.config.item.style);b.innerHTML=c;if(d===0)a.itemSelected=b;MKWrapper.attachEvent(b,g,function(){a.itemSelect(a,this)},b);MKWrapper.attachEvent(b,"click",function(){a.listSelect(a,this)},b);a.oList.insertBefore(b,a.oList.lastChild)});MKWrapper.setStyle(a.oList,{width:"auto",height:"auto"});for(var d=0,h=0,c=MKWrapper.findChilds(a.oList),b=0,j=c.length;b<j;++b){var f=MKWrapper.getDimensions(c[b]);d=f.width>d?f.width:d;h+=f.height;MKWrapper.attachEvent(c[b],g,function(){MKWrapper.setStyle(this,{visibility:"visible"})});MKWrapper.attachEvent(c[b],"mouseout",function(){MKWrapper.setStyle(this,{visibility:"hidden"})})}MKWrapper.setStyle(a.oList,{width:d+"px",height:h+"px"});this.showItemList(a)},disableButtons:function(){MKWrapper.each(MKWrapper.findChilds(MKWrapper.$(this.oForm.sFormId),"input[type=submit]"),function(a){MKWrapper.$(a).disabled=true});MKWrapper.each(MKWrapper.findChilds(MKWrapper.$(this.oForm.sFormId),"input[type=button]"),function(a){MKWrapper.$(a).disabled=true})},enableButtons:function(){MKWrapper.each(MKWrapper.findChilds(MKWrapper.$(this.oForm.sFormId),"input[type=submit]"),function(a){MKWrapper.$(a).disabled=false});MKWrapper.each(MKWrapper.findChilds(MKWrapper.$(this.oForm.sFormId),"input[type=button]"),function(a){MKWrapper.$(a).disabled=false})},setDbEntryState:function(a){this.config.isDbEntry=a},showItemList:function(a){MKWrapper.setStyle(MKWrapper.parent(a.oList),{zIndex:"20000"});MKWrapper.setStyle(a.oList,{zIndex:"30000"});a.oList.style.visibility="visible";a.oText.focus();this.config.selectionRequired&&this.disableButtons();a.itemSelect(a,a.itemSelected)},hideItemListOnLeave:function(){this.hideItemList(this)},hideItemList:function(a){a.oList.innerHTML="";MKWrapper.setStyle(MKWrapper.parent(a.oList),{zIndex:"10000"});MKWrapper.setStyle(a.oList,{zIndex:"0"});a.oList.style.visibility="hidden";this.config.selectionRequired&&this.enableButtons();a.itemSelected=null},addHandler:function(b,a){switch(b){case"onlistselect":this.onlistselect=a}}});